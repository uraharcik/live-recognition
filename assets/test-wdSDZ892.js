import{r as l,c as k,l as A,e as V,a as W,b as X,j as e}from"./index-DEpWkE3S.js";const _=["blink","turnLeft","turnRight","smile","openMouth","raiseEyebrows","squint","lookUp","lookDown","winkLeft","winkRight","purseLips","frown"],C={blink:"Blink",turnLeft:"Turn Left",turnRight:"Turn Right",smile:"Smile",openMouth:"Open Mouth",raiseEyebrows:"Raise Eyebrows",squint:"Squint",lookUp:"Look Up",lookDown:"Look Down",winkLeft:"Wink Left",winkRight:"Wink Right",purseLips:"Purse Lips",frown:"Frown"},s={blink:.5,smile:.4,jawOpen:.3,headTurn:.15,browRaise:.35,squint:.4,eyeLook:.4,wink:.5,winkOpenEye:.3,purseLips:.4,frown:.3};function z(r,t,o){switch(r){case"blink":return[{label:"Avg Blink",value:(t.eyeBlinkLeft+t.eyeBlinkRight)/2,threshold:s.blink},{label:"L Eye Blink",value:t.eyeBlinkLeft,threshold:s.blink},{label:"R Eye Blink",value:t.eyeBlinkRight,threshold:s.blink}];case"turnLeft":return[{label:"Head Yaw",value:o.yaw,threshold:-.15,inverted:!0}];case"turnRight":return[{label:"Head Yaw",value:o.yaw,threshold:s.headTurn}];case"smile":return[{label:"Avg Smile",value:(t.mouthSmileLeft+t.mouthSmileRight)/2,threshold:s.smile},{label:"L Smile",value:t.mouthSmileLeft,threshold:s.smile},{label:"R Smile",value:t.mouthSmileRight,threshold:s.smile}];case"openMouth":return[{label:"Jaw Open",value:t.jawOpen,threshold:s.jawOpen}];case"raiseEyebrows":return[{label:"Avg Brow",value:(t.browOuterUpLeft+t.browOuterUpRight+t.browInnerUp)/3,threshold:s.browRaise},{label:"Inner Up",value:t.browInnerUp,threshold:s.browRaise},{label:"L Outer Up",value:t.browOuterUpLeft,threshold:s.browRaise},{label:"R Outer Up",value:t.browOuterUpRight,threshold:s.browRaise}];case"squint":return[{label:"Avg Squint",value:(t.eyeSquintLeft+t.eyeSquintRight)/2,threshold:s.squint},{label:"Avg Blink (must be <0.5)",value:(t.eyeBlinkLeft+t.eyeBlinkRight)/2,threshold:s.blink,inverted:!0}];case"lookUp":return[{label:"Avg Look Up",value:(t.eyeLookUpLeft+t.eyeLookUpRight)/2,threshold:s.eyeLook},{label:"L Look Up",value:t.eyeLookUpLeft,threshold:s.eyeLook},{label:"R Look Up",value:t.eyeLookUpRight,threshold:s.eyeLook}];case"lookDown":return[{label:"Avg Look Down",value:(t.eyeLookDownLeft+t.eyeLookDownRight)/2,threshold:s.eyeLook},{label:"L Look Down",value:t.eyeLookDownLeft,threshold:s.eyeLook},{label:"R Look Down",value:t.eyeLookDownRight,threshold:s.eyeLook}];case"winkLeft":return[{label:"L Eye Blink (>0.5)",value:t.eyeBlinkLeft,threshold:s.wink},{label:"R Eye Blink (<0.3)",value:t.eyeBlinkRight,threshold:s.winkOpenEye,inverted:!0}];case"winkRight":return[{label:"R Eye Blink (>0.5)",value:t.eyeBlinkRight,threshold:s.wink},{label:"L Eye Blink (<0.3)",value:t.eyeBlinkLeft,threshold:s.winkOpenEye,inverted:!0}];case"purseLips":return[{label:"Mouth Pucker",value:t.mouthPucker,threshold:s.purseLips}];case"frown":return[{label:"Avg Mouth Frown",value:(t.mouthFrownLeft+t.mouthFrownRight)/2,threshold:s.frown},{label:"Avg Brow Down",value:(t.browDownLeft+t.browDownRight)/2,threshold:s.frown}];default:return[]}}function J({label:r,value:t,threshold:o,inverted:g}){const m=Math.min(Math.max(Math.abs(t),0),1),c=Math.abs(o),b=g?t<o:t>o,y=m*100,f=c*100;return e.jsxs("div",{className:"mb-2",children:[e.jsxs("div",{className:"flex justify-between text-xs mb-0.5",children:[e.jsx("span",{className:"text-gray-300",children:r}),e.jsx("span",{className:b?"text-green-400 font-bold":"text-gray-400",children:t.toFixed(3)})]}),e.jsxs("div",{className:"relative h-4 bg-gray-800 rounded overflow-hidden",children:[e.jsx("div",{className:`absolute inset-y-0 left-0 rounded transition-all duration-75 ${b?"bg-green-500":"bg-orange-500"}`,style:{width:`${y}%`}}),e.jsx("div",{className:"absolute inset-y-0 w-0.5 bg-white/80",style:{left:`${f}%`}}),e.jsx("span",{className:"absolute text-[9px] text-white/60 top-0",style:{left:`${f+1}%`},children:c})]})]})}function Q(){const r=l.useRef(null),[t,o]=l.useState(!1),[g,m]=l.useState(!1),[c,b]=l.useState("blink"),[y,f]=l.useState(null),[x,$]=l.useState({yaw:0,pitch:0}),[d,N]=l.useState(k()),[B,D]=l.useState([]),[E,U]=l.useState(!1),[L,P]=l.useState([]),n=l.useRef(null),p=l.useRef(0),v=l.useRef(k()),q=l.useCallback(()=>{n.current&&(clearInterval(n.current),n.current=null),o(!1)},[]),M=l.useCallback(()=>{const a=k();v.current=a,N(a)},[]),w=l.useCallback(async()=>{const a=r.current;if(!a)return;const u=await A();if(!u)return;const i=performance.now();if(i<=p.current)return;p.current=i;const h=u.detectForVideo(a,i);if(!h.faceLandmarks||h.faceLandmarks.length===0){U(!1);return}U(!0);const R=h.faceBlendshapes?.[0]?.categories;if(!R)return;const F=V(R),Y=h.faceLandmarks[0],T=W(Y);f(F),$(T),P([...R].sort((j,S)=>j.categoryName.localeCompare(S.categoryName)));const{completed:G,newState:I}=X(c,F,T,v.current);if(v.current=I,N(I),G){D(S=>[{challenge:c,time:new Date().toLocaleTimeString(),success:!0},...S.slice(0,19)]);const j=k();v.current=j,N(j)}},[c]),H=l.useCallback(async()=>{m(!0);try{await A()}catch(a){console.error("Failed to load model:",a),m(!1);return}m(!1),o(!0),p.current=0,n.current=window.setInterval(w,50)},[w]);l.useEffect(()=>{let a=!0;return(async()=>{try{const i=await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:"user"}},audio:!1});a&&r.current?(r.current.srcObject=i,r.current.play().catch(console.error)):i.getTracks().forEach(h=>h.stop())}catch(i){console.error("Camera error:",i)}})(),()=>{a=!1}},[]),l.useEffect(()=>{if(t)return n.current&&clearInterval(n.current),p.current=0,n.current=window.setInterval(w,50),()=>{n.current&&clearInterval(n.current)}},[t,w]),l.useEffect(()=>()=>{n.current&&clearInterval(n.current);const a=r.current;if(a?.srcObject){const u=a.srcObject;u instanceof MediaStream&&u.getTracks().forEach(i=>i.stop())}},[]);const O=y?z(c,y,x):[];return e.jsx("div",{className:"min-h-screen bg-gray-950 text-white p-4",children:e.jsxs("div",{className:"max-w-6xl mx-auto",children:[e.jsx("h1",{className:"text-2xl font-bold mb-4",children:"Challenge Testing Frame"}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"lg:col-span-1",children:[e.jsxs("div",{className:"relative aspect-[3/4] bg-black rounded-xl overflow-hidden mb-4",children:[e.jsx("video",{ref:r,autoPlay:!0,playsInline:!0,muted:!0,className:"w-full h-full object-cover scale-x-[-1]"}),e.jsx("div",{className:`absolute top-3 left-3 px-3 py-1 rounded-full text-xs font-medium ${E?"bg-green-500/80 text-white":"bg-red-500/80 text-white"}`,children:E?"Face Detected":"No Face"}),t&&e.jsx("div",{className:"absolute top-3 right-3 px-3 py-1 rounded-full text-xs font-medium bg-orange-500/80 text-white animate-pulse",children:"Detecting"})]}),e.jsxs("div",{className:"flex gap-2 mb-4",children:[t?e.jsx("button",{type:"button",onClick:q,className:"flex-1 py-3 rounded-xl bg-red-600 hover:bg-red-700 transition font-medium",children:"Stop"}):e.jsx("button",{type:"button",onClick:H,disabled:g,className:"flex-1 py-3 rounded-xl bg-orange-500 hover:bg-orange-600 transition font-medium disabled:opacity-50",children:g?"Loading Model...":"Start Detection"}),e.jsx("button",{type:"button",onClick:M,className:"px-4 py-3 rounded-xl bg-gray-700 hover:bg-gray-600 transition font-medium",children:"Reset State"})]}),e.jsxs("div",{className:"bg-gray-900 rounded-xl p-3 mb-4",children:[e.jsx("h3",{className:"text-sm font-medium text-gray-400 mb-2",children:"Internal Challenge State"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-xs",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"eyesClosed"}),e.jsx("span",{className:d.eyesClosed?"text-green-400":"text-gray-600",children:String(d.eyesClosed)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"eyesClosedTime"}),e.jsx("span",{className:"text-gray-400",children:d.eyesClosedTime?`${Date.now()-d.eyesClosedTime}ms`:"null"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"turnedLeft"}),e.jsx("span",{className:d.turnedLeft?"text-green-400":"text-gray-600",children:String(d.turnedLeft)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"turnedRight"}),e.jsx("span",{className:d.turnedRight?"text-green-400":"text-gray-600",children:String(d.turnedRight)})]})]})]}),e.jsxs("div",{className:"bg-gray-900 rounded-xl p-3",children:[e.jsx("h3",{className:"text-sm font-medium text-gray-400 mb-2",children:"Head Pose"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between text-xs mb-0.5",children:[e.jsx("span",{className:"text-gray-400",children:"Yaw (L/R)"}),e.jsx("span",{className:"text-gray-300",children:x.yaw.toFixed(3)})]}),e.jsxs("div",{className:"relative h-3 bg-gray-800 rounded overflow-hidden",children:[e.jsx("div",{className:"absolute inset-y-0 left-1/2 w-px bg-gray-600"}),e.jsx("div",{className:"absolute inset-y-0 w-2 bg-orange-500 rounded",style:{left:`${50+x.yaw*50}%`,transform:"translateX(-50%)"}})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between text-xs mb-0.5",children:[e.jsx("span",{className:"text-gray-400",children:"Pitch (U/D)"}),e.jsx("span",{className:"text-gray-300",children:x.pitch.toFixed(3)})]}),e.jsxs("div",{className:"relative h-3 bg-gray-800 rounded overflow-hidden",children:[e.jsx("div",{className:"absolute inset-y-0 left-1/2 w-px bg-gray-600"}),e.jsx("div",{className:"absolute inset-y-0 w-2 bg-orange-500 rounded",style:{left:`${50+x.pitch*50}%`,transform:"translateX(-50%)"}})]})]})]})]})]}),e.jsxs("div",{className:"lg:col-span-1",children:[e.jsxs("div",{className:"bg-gray-900 rounded-xl p-3 mb-4",children:[e.jsx("h3",{className:"text-sm font-medium text-gray-400 mb-2",children:"Select Challenge"}),e.jsx("div",{className:"grid grid-cols-2 gap-1.5",children:_.map(a=>e.jsx("button",{type:"button",onClick:()=>{b(a),M()},className:`px-3 py-2 rounded-lg text-xs font-medium transition ${c===a?"bg-orange-500 text-white":"bg-gray-800 text-gray-400 hover:bg-gray-700"}`,children:C[a]},a))})]}),e.jsxs("div",{className:"bg-gray-900 rounded-xl p-3 mb-4",children:[e.jsxs("h3",{className:"text-sm font-medium text-gray-400 mb-2",children:["Metrics for: ",C[c]]}),O.length>0?O.map(a=>e.jsx(J,{label:a.label,value:a.value,threshold:a.threshold,inverted:a.inverted},a.label)):e.jsx("p",{className:"text-gray-600 text-xs",children:"Start detection to see metrics"})]}),e.jsxs("div",{className:"bg-gray-900 rounded-xl p-3",children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsx("h3",{className:"text-sm font-medium text-gray-400",children:"Completion Log"}),e.jsx("button",{type:"button",onClick:()=>D([]),className:"text-xs text-gray-600 hover:text-gray-400",children:"Clear"})]}),B.length===0?e.jsx("p",{className:"text-gray-600 text-xs",children:"No completions yet. Perform challenges to test."}):e.jsx("div",{className:"space-y-1 max-h-64 overflow-y-auto",children:B.map((a,u)=>e.jsxs("div",{className:"flex justify-between text-xs py-1 border-b border-gray-800",children:[e.jsx("span",{className:"text-green-400",children:C[a.challenge]}),e.jsx("span",{className:"text-gray-500",children:a.time})]},`${a.time}-${u}`))})]})]}),e.jsx("div",{className:"lg:col-span-1",children:e.jsxs("div",{className:"bg-gray-900 rounded-xl p-3",children:[e.jsxs("h3",{className:"text-sm font-medium text-gray-400 mb-2",children:["Raw MediaPipe Blendshapes (",L.length,")"]}),L.length>0?e.jsx("div",{className:"space-y-1.5 max-h-[calc(100vh-120px)] overflow-y-auto",children:L.map(a=>e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between text-[10px] mb-0.5",children:[e.jsx("span",{className:a.categoryName.toLowerCase().includes("cheek")?"text-yellow-400 font-bold":"text-gray-500",children:a.categoryName}),e.jsx("span",{className:a.score>.3?"text-orange-400":"text-gray-600",children:a.score.toFixed(4)})]}),e.jsx("div",{className:"relative h-2 bg-gray-800 rounded overflow-hidden",children:e.jsx("div",{className:`absolute inset-y-0 left-0 rounded transition-all duration-75 ${a.score>.3?"bg-orange-500/70":"bg-gray-600"}`,style:{width:`${Math.min(a.score*100,100)}%`}})})]},a.categoryName))}):e.jsx("p",{className:"text-gray-600 text-xs",children:"Start detection to see scores"})]})})]})]})})}export{Q as component};
