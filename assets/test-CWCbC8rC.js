import{r as l,c as j,l as P,e as Y,a as G,b as V,j as e}from"./index-DKNWZMGV.js";const W=["blink","turnLeft","turnRight","smile","openMouth","raiseEyebrows","squint","puffCheeks","lookUp","lookDown","winkLeft","winkRight","purseLips","frown"],L={blink:"Blink",turnLeft:"Turn Left",turnRight:"Turn Right",smile:"Smile",openMouth:"Open Mouth",raiseEyebrows:"Raise Eyebrows",squint:"Squint",puffCheeks:"Puff Cheeks",lookUp:"Look Up",lookDown:"Look Down",winkLeft:"Wink Left",winkRight:"Wink Right",purseLips:"Purse Lips",frown:"Frown"},s={blink:.5,smile:.4,jawOpen:.3,headTurn:.15,browRaise:.35,squint:.4,cheekPuff:.3,eyeLook:.4,wink:.5,winkOpenEye:.3,purseLips:.4,frown:.3};function X(i,t,c){switch(i){case"blink":return[{label:"Avg Blink",value:(t.eyeBlinkLeft+t.eyeBlinkRight)/2,threshold:s.blink},{label:"L Eye Blink",value:t.eyeBlinkLeft,threshold:s.blink},{label:"R Eye Blink",value:t.eyeBlinkRight,threshold:s.blink}];case"turnLeft":return[{label:"Head Yaw",value:c.yaw,threshold:-.15,inverted:!0}];case"turnRight":return[{label:"Head Yaw",value:c.yaw,threshold:s.headTurn}];case"smile":return[{label:"Avg Smile",value:(t.mouthSmileLeft+t.mouthSmileRight)/2,threshold:s.smile},{label:"L Smile",value:t.mouthSmileLeft,threshold:s.smile},{label:"R Smile",value:t.mouthSmileRight,threshold:s.smile}];case"openMouth":return[{label:"Jaw Open",value:t.jawOpen,threshold:s.jawOpen}];case"raiseEyebrows":return[{label:"Avg Brow",value:(t.browOuterUpLeft+t.browOuterUpRight+t.browInnerUp)/3,threshold:s.browRaise},{label:"Inner Up",value:t.browInnerUp,threshold:s.browRaise},{label:"L Outer Up",value:t.browOuterUpLeft,threshold:s.browRaise},{label:"R Outer Up",value:t.browOuterUpRight,threshold:s.browRaise}];case"squint":return[{label:"Avg Squint",value:(t.eyeSquintLeft+t.eyeSquintRight)/2,threshold:s.squint},{label:"Avg Blink (must be <0.5)",value:(t.eyeBlinkLeft+t.eyeBlinkRight)/2,threshold:s.blink,inverted:!0}];case"puffCheeks":return[{label:"Cheek Puff",value:t.cheekPuff,threshold:s.cheekPuff}];case"lookUp":return[{label:"Avg Look Up",value:(t.eyeLookUpLeft+t.eyeLookUpRight)/2,threshold:s.eyeLook},{label:"L Look Up",value:t.eyeLookUpLeft,threshold:s.eyeLook},{label:"R Look Up",value:t.eyeLookUpRight,threshold:s.eyeLook}];case"lookDown":return[{label:"Avg Look Down",value:(t.eyeLookDownLeft+t.eyeLookDownRight)/2,threshold:s.eyeLook},{label:"L Look Down",value:t.eyeLookDownLeft,threshold:s.eyeLook},{label:"R Look Down",value:t.eyeLookDownRight,threshold:s.eyeLook}];case"winkLeft":return[{label:"L Eye Blink (>0.5)",value:t.eyeBlinkLeft,threshold:s.wink},{label:"R Eye Blink (<0.3)",value:t.eyeBlinkRight,threshold:s.winkOpenEye,inverted:!0}];case"winkRight":return[{label:"R Eye Blink (>0.5)",value:t.eyeBlinkRight,threshold:s.wink},{label:"L Eye Blink (<0.3)",value:t.eyeBlinkLeft,threshold:s.winkOpenEye,inverted:!0}];case"purseLips":return[{label:"Mouth Pucker",value:t.mouthPucker,threshold:s.purseLips}];case"frown":return[{label:"Avg Mouth Frown",value:(t.mouthFrownLeft+t.mouthFrownRight)/2,threshold:s.frown},{label:"Avg Brow Down",value:(t.browDownLeft+t.browDownRight)/2,threshold:s.frown}];default:return[]}}function _({label:i,value:t,threshold:c,inverted:f}){const m=Math.min(Math.max(Math.abs(t),0),1),d=Math.abs(c),b=f?t<c:t>c,h=m*100,y=d*100;return e.jsxs("div",{className:"mb-2",children:[e.jsxs("div",{className:"flex justify-between text-xs mb-0.5",children:[e.jsx("span",{className:"text-gray-300",children:i}),e.jsx("span",{className:b?"text-green-400 font-bold":"text-gray-400",children:t.toFixed(3)})]}),e.jsxs("div",{className:"relative h-4 bg-gray-800 rounded overflow-hidden",children:[e.jsx("div",{className:`absolute inset-y-0 left-0 rounded transition-all duration-75 ${b?"bg-green-500":"bg-orange-500"}`,style:{width:`${h}%`}}),e.jsx("div",{className:"absolute inset-y-0 w-0.5 bg-white/80",style:{left:`${y}%`}}),e.jsx("span",{className:"absolute text-[9px] text-white/60 top-0",style:{left:`${y+1}%`},children:d})]})]})}function J(){const i=l.useRef(null),[t,c]=l.useState(!1),[f,m]=l.useState(!1),[d,b]=l.useState("blink"),[h,y]=l.useState(null),[g,T]=l.useState({yaw:0,pitch:0}),[u,k]=l.useState(j()),[N,R]=l.useState([]),[S,C]=l.useState(!1),r=l.useRef(null),p=l.useRef(0),v=l.useRef(j()),A=l.useCallback(()=>{r.current&&(clearInterval(r.current),r.current=null),c(!1)},[]),B=l.useCallback(()=>{const a=j();v.current=a,k(a)},[]),w=l.useCallback(async()=>{const a=i.current;if(!a)return;const n=await P();if(!n)return;const o=performance.now();if(o<=p.current)return;p.current=o;const x=n.detectForVideo(a,o);if(!x.faceLandmarks||x.faceLandmarks.length===0){C(!1);return}C(!0);const E=x.faceBlendshapes?.[0]?.categories;if(!E)return;const U=Y(E),$=x.faceLandmarks[0],O=G($);y(U),T(O);const{completed:q,newState:M}=V(d,U,O,v.current);if(v.current=M,k(M),q){R(H=>[{challenge:d,time:new Date().toLocaleTimeString(),success:!0},...H.slice(0,19)]);const F=j();v.current=F,k(F)}},[d]),I=l.useCallback(async()=>{m(!0);try{await P()}catch(a){console.error("Failed to load model:",a),m(!1);return}m(!1),c(!0),p.current=0,r.current=window.setInterval(w,50)},[w]);l.useEffect(()=>{let a=!0;return(async()=>{try{const o=await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:"user"}},audio:!1});a&&i.current?(i.current.srcObject=o,i.current.play().catch(console.error)):o.getTracks().forEach(x=>x.stop())}catch(o){console.error("Camera error:",o)}})(),()=>{a=!1}},[]),l.useEffect(()=>{if(t)return r.current&&clearInterval(r.current),p.current=0,r.current=window.setInterval(w,50),()=>{r.current&&clearInterval(r.current)}},[t,w]),l.useEffect(()=>()=>{r.current&&clearInterval(r.current);const a=i.current;if(a?.srcObject){const n=a.srcObject;n instanceof MediaStream&&n.getTracks().forEach(o=>o.stop())}},[]);const D=h?X(d,h,g):[];return e.jsx("div",{className:"min-h-screen bg-gray-950 text-white p-4",children:e.jsxs("div",{className:"max-w-6xl mx-auto",children:[e.jsx("h1",{className:"text-2xl font-bold mb-4",children:"Challenge Testing Frame"}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"lg:col-span-1",children:[e.jsxs("div",{className:"relative aspect-[3/4] bg-black rounded-xl overflow-hidden mb-4",children:[e.jsx("video",{ref:i,autoPlay:!0,playsInline:!0,muted:!0,className:"w-full h-full object-cover scale-x-[-1]"}),e.jsx("div",{className:`absolute top-3 left-3 px-3 py-1 rounded-full text-xs font-medium ${S?"bg-green-500/80 text-white":"bg-red-500/80 text-white"}`,children:S?"Face Detected":"No Face"}),t&&e.jsx("div",{className:"absolute top-3 right-3 px-3 py-1 rounded-full text-xs font-medium bg-orange-500/80 text-white animate-pulse",children:"Detecting"})]}),e.jsxs("div",{className:"flex gap-2 mb-4",children:[t?e.jsx("button",{type:"button",onClick:A,className:"flex-1 py-3 rounded-xl bg-red-600 hover:bg-red-700 transition font-medium",children:"Stop"}):e.jsx("button",{type:"button",onClick:I,disabled:f,className:"flex-1 py-3 rounded-xl bg-orange-500 hover:bg-orange-600 transition font-medium disabled:opacity-50",children:f?"Loading Model...":"Start Detection"}),e.jsx("button",{type:"button",onClick:B,className:"px-4 py-3 rounded-xl bg-gray-700 hover:bg-gray-600 transition font-medium",children:"Reset State"})]}),e.jsxs("div",{className:"bg-gray-900 rounded-xl p-3 mb-4",children:[e.jsx("h3",{className:"text-sm font-medium text-gray-400 mb-2",children:"Internal Challenge State"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-xs",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"eyesClosed"}),e.jsx("span",{className:u.eyesClosed?"text-green-400":"text-gray-600",children:String(u.eyesClosed)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"eyesClosedTime"}),e.jsx("span",{className:"text-gray-400",children:u.eyesClosedTime?`${Date.now()-u.eyesClosedTime}ms`:"null"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"turnedLeft"}),e.jsx("span",{className:u.turnedLeft?"text-green-400":"text-gray-600",children:String(u.turnedLeft)})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-500",children:"turnedRight"}),e.jsx("span",{className:u.turnedRight?"text-green-400":"text-gray-600",children:String(u.turnedRight)})]})]})]}),e.jsxs("div",{className:"bg-gray-900 rounded-xl p-3",children:[e.jsx("h3",{className:"text-sm font-medium text-gray-400 mb-2",children:"Head Pose"}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between text-xs mb-0.5",children:[e.jsx("span",{className:"text-gray-400",children:"Yaw (L/R)"}),e.jsx("span",{className:"text-gray-300",children:g.yaw.toFixed(3)})]}),e.jsxs("div",{className:"relative h-3 bg-gray-800 rounded overflow-hidden",children:[e.jsx("div",{className:"absolute inset-y-0 left-1/2 w-px bg-gray-600"}),e.jsx("div",{className:"absolute inset-y-0 w-2 bg-orange-500 rounded",style:{left:`${50+g.yaw*50}%`,transform:"translateX(-50%)"}})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between text-xs mb-0.5",children:[e.jsx("span",{className:"text-gray-400",children:"Pitch (U/D)"}),e.jsx("span",{className:"text-gray-300",children:g.pitch.toFixed(3)})]}),e.jsxs("div",{className:"relative h-3 bg-gray-800 rounded overflow-hidden",children:[e.jsx("div",{className:"absolute inset-y-0 left-1/2 w-px bg-gray-600"}),e.jsx("div",{className:"absolute inset-y-0 w-2 bg-orange-500 rounded",style:{left:`${50+g.pitch*50}%`,transform:"translateX(-50%)"}})]})]})]})]})]}),e.jsxs("div",{className:"lg:col-span-1",children:[e.jsxs("div",{className:"bg-gray-900 rounded-xl p-3 mb-4",children:[e.jsx("h3",{className:"text-sm font-medium text-gray-400 mb-2",children:"Select Challenge"}),e.jsx("div",{className:"grid grid-cols-2 gap-1.5",children:W.map(a=>e.jsx("button",{type:"button",onClick:()=>{b(a),B()},className:`px-3 py-2 rounded-lg text-xs font-medium transition ${d===a?"bg-orange-500 text-white":"bg-gray-800 text-gray-400 hover:bg-gray-700"}`,children:L[a]},a))})]}),e.jsxs("div",{className:"bg-gray-900 rounded-xl p-3 mb-4",children:[e.jsxs("h3",{className:"text-sm font-medium text-gray-400 mb-2",children:["Metrics for: ",L[d]]}),D.length>0?D.map(a=>e.jsx(_,{label:a.label,value:a.value,threshold:a.threshold,inverted:a.inverted},a.label)):e.jsx("p",{className:"text-gray-600 text-xs",children:"Start detection to see metrics"})]}),e.jsxs("div",{className:"bg-gray-900 rounded-xl p-3",children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsx("h3",{className:"text-sm font-medium text-gray-400",children:"Completion Log"}),e.jsx("button",{type:"button",onClick:()=>R([]),className:"text-xs text-gray-600 hover:text-gray-400",children:"Clear"})]}),N.length===0?e.jsx("p",{className:"text-gray-600 text-xs",children:"No completions yet. Perform challenges to test."}):e.jsx("div",{className:"space-y-1 max-h-64 overflow-y-auto",children:N.map((a,n)=>e.jsxs("div",{className:"flex justify-between text-xs py-1 border-b border-gray-800",children:[e.jsx("span",{className:"text-green-400",children:L[a.challenge]}),e.jsx("span",{className:"text-gray-500",children:a.time})]},`${a.time}-${n}`))})]})]}),e.jsx("div",{className:"lg:col-span-1",children:e.jsxs("div",{className:"bg-gray-900 rounded-xl p-3",children:[e.jsx("h3",{className:"text-sm font-medium text-gray-400 mb-2",children:"All Blendshape Scores"}),h?e.jsx("div",{className:"space-y-1.5 max-h-[calc(100vh-120px)] overflow-y-auto",children:Object.entries(h).map(([a,n])=>e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between text-[10px] mb-0.5",children:[e.jsx("span",{className:"text-gray-500",children:a}),e.jsx("span",{className:n>.3?"text-orange-400":"text-gray-600",children:n.toFixed(3)})]}),e.jsx("div",{className:"relative h-2 bg-gray-800 rounded overflow-hidden",children:e.jsx("div",{className:`absolute inset-y-0 left-0 rounded transition-all duration-75 ${n>.3?"bg-orange-500/70":"bg-gray-600"}`,style:{width:`${Math.min(n*100,100)}%`}})})]},a))}):e.jsx("p",{className:"text-gray-600 text-xs",children:"Start detection to see scores"})]})})]})]})})}export{J as component};
